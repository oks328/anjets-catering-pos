{% extends "base.html" %}

{% block title %}Your Shopping Cart{% endblock %}

{% block content %}
<div class="cart-container">
    <h2 style="margin-bottom: 2rem; font-weight: 800;">Your Shopping Cart</h2>

    {# --- 1. SHOPPING CART SECTION --- #}
    {% if not cart_items %}
        <div class="card" style="text-align: center; padding: 4rem;">
            <div style="font-size: 3rem; color: #e5e7eb; margin-bottom: 1rem;">
                <i class="fa-solid fa-cart-shopping"></i>
            </div>
            <p style="color: var(--text-gray); margin-bottom: 2rem; font-size: 1.1rem;">Your cart is currently empty.</p>
            <a href="{{ url_for('client_menu') }}" class="btn btn-primary">Start Shopping</a>
        </div>
    {% else %}
    
    <div class="cart-content-wrapper">
        
        <div class="cart-items-panel">
            <div class="cart-header-action">
                <h3>Items ({{ cart_items|length }})</h3>
                <a href="#" onclick="openClearCartModal('{{ url_for('clear_cart') }}'); return false;" 
                   style="color: var(--danger-red); font-size: 0.85rem; font-weight: 600;">
                    <i class="fa-solid fa-trash-can"></i> Clear All
                </a>
            </div>

            <table class="cart-table">
                <thead>
                    <tr>
                        <th colspan="2">Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th style="text-align: right;">Total</th>
                        <th style="width: 50px;"></th> 
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart_items %}
                    <tr>
                        <td colspan="2">
                            <div class="cart-item-details">
                                <img src="{{ url_for('static', filename='uploads/products/' + item.image) }}"
                                    alt="{{ item.name }}">
                                <div>
                                    <a href="#" style="font-weight: 600; font-size: 1rem; display: block; margin-bottom: 0.2rem;">{{ item.name }}</a>
                                    <span class="variant-name" style="color: var(--text-gray); font-size: 0.85rem;">{{ item.variant_name }}</span>
                                    {% if item.is_buffet_item %}
                                    <span class="variant-name" style="color: #3b82f6; font-weight: 600; font-size: 0.75rem; display: block; margin-top: 4px; background: #eff6ff; width: fit-content; padding: 2px 6px; border-radius: 4px;">
                                        Buffet Item
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>₱{{ "%.2f"|format(item.price) }}</td>
                        <td>
                            <form action="{{ url_for('update_cart_quantity') }}" method="POST" class="quantity-form-auto">
                                <input type="hidden" name="variant_id" value="{{ item.variant_id }}">
                                
                                <div class="quantity-stepper">
                                    <button type="button" class="btn-qty" 
                                            data-remove-url="{{ url_for('remove_from_cart', variant_id=item.variant_id) }}"
                                            onclick="updateCartQty(this, -1)">-</button>
                                    
                                    <input type="number" name="quantity" value="{{ item.quantity }}" min="1" class="form-control-qty" readonly>
                                    
                                    <button type="button" class="btn-qty" onclick="updateCartQty(this, 1)">+</button>
                                </div>
                            </form>
                        </td>
                        <td style="text-align: right; font-weight: 700;">₱{{ "%.2f"|format(item.line_total) }}</td>
                        <td style="text-align: right;">
                            <button type="button" 
                                    onclick="openRemoveModal('{{ url_for('remove_from_cart', variant_id=item.variant_id) }}')"
                                    style="color: var(--text-light); background: none; border: none; cursor: pointer; font-size: 1.1rem; transition: color 0.2s;"
                                    onmouseover="this.style.color='var(--danger-red)'"
                                    onmouseout="this.style.color='var(--text-light)'"
                                    title="Remove Item">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="cart-summary-panel">
            <h3>Order Summary</h3>

            {% if customer and not customer.is_verified_discount %}
                <div style="margin-bottom: 1.5rem;">
                    {% if available_vouchers %}
                    <div style="margin-bottom: 0.8rem;">
                        <small style="color: var(--text-gray);">Available Codes:</small>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.4rem;">
                            {% for voucher in available_vouchers %}
                            <button type="button" class="btn btn-secondary" style="padding: 0.2rem 0.6rem; font-size: 0.75rem; border-radius: 20px;" 
                                    onclick="applyVoucherCode('{{ voucher.code }}')">
                                {{ voucher.code }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <form action="{{ url_for('apply_voucher') }}" method="POST" id="voucherForm" style="display: flex; gap: 0.5rem;">
                        <input type="text" id="voucherCodeInput" name="voucher_code" class="form-control"
                            placeholder="Discount Code" value="{{ session.get('voucher_code', '') }}" style="font-size: 0.9rem;">
                        <button type="submit" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Apply</button>
                    </form>
                </div>
                <hr style="border: 0; border-top: 1px solid var(--border-color); margin-bottom: 1.5rem;">
            {% endif %}

            <div class="summary-row">
                <span>À La Carte Subtotal</span>
                <span>₱{{ "%.2f"|format(ala_carte_subtotal) }}</span>
            </div>
            <div class="summary-row">
                <span>Buffet Subtotal</span>
                <span>₱{{ "%.2f"|format(buffet_subtotal) }}</span>
            </div>

            {% if voucher_discount_amt > 0 %}
            <div class="summary-row">
                <span class="discount-text">Voucher ({{ session.get('voucher_code') }})</span>
                <span class="discount-text">- ₱{{ "%.2f"|format(voucher_discount_amt) }}</span>
            </div>
            {% endif %}

            {% if senior_discount_amt > 0 %}
            <div class="summary-row">
                <span class="discount-text">Senior Discount (20%)</span>
                <span class="discount-text">- ₱{{ "%.2f"|format(senior_discount_amt) }}</span>
            </div>
            {% endif %}

            {% if pwd_discount_amt > 0 %}
            <div class="summary-row">
                <span class="discount-text">PWD Discount</span>
                <span class="discount-text">- ₱{{ "%.2f"|format(pwd_discount_amt) }}</span>
            </div>
            {% endif %}

            <div class="summary-row">
                <span>VAT (12%)</span>
                <span>+ ₱{{ "%.2f"|format(vat_amount) }}</span>
            </div>

            <div class="summary-row total">
                <span>Total</span>
                <span>₱{{ "%.2f"|format(final_total) }}</span>
            </div>

            <a href="{{ url_for('client_checkout_options') }}" class="btn-checkout">
                Proceed to Checkout <i class="fa-solid fa-arrow-right" style="margin-left: 8px;"></i>
            </a>
        </div>

    </div>
    {% endif %}
    </div>

{# --- MODAL FOR REMOVING ITEMS --- #}
<div id="removeItemModal" class="modal">
    <div class="modal-content">
        <span class="modal-close-btn" id="removeItemModalCloseBtn">&times;</span>
        <h4 style="margin-top: 0;">Remove Item?</h4>
        <p>Are you sure you want to remove this item from your cart?</p>
        <div class="modal-actions" style="text-align: right; margin-top: 1.5rem;">
            <button type="button" id="removeItemModalCancel" class="btn btn-secondary">Cancel</button>
            <a href="#" id="removeItemModalConfirm" class="btn btn-danger">Remove</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const removeItemModal = document.getElementById('removeItemModal');
        const removeItemCloseBtn = document.getElementById('removeItemModalCloseBtn');
        const removeItemCancelBtn = document.getElementById('removeItemModalCancel');

        const closeRemoveItemModal = () => {
            if (removeItemModal) removeItemModal.style.display = 'none';
        }

        if (removeItemCloseBtn) removeItemCloseBtn.onclick = closeRemoveItemModal;
        if (removeItemCancelBtn) removeItemCancelBtn.onclick = closeRemoveItemModal;

        window.addEventListener('click', (event) => {
            if (event.target === removeItemModal) closeRemoveItemModal();
        });
    });

    function openRemoveModal(removeUrl) {
        const modal = document.getElementById('removeItemModal');
        const confirmBtn = document.getElementById('removeItemModalConfirm');
        
        if (modal && confirmBtn) {
            confirmBtn.href = removeUrl;
            modal.style.display = 'block';
        }
    }

    function applyVoucherCode(code) {
        document.getElementById('voucherCodeInput').value = code;
        document.getElementById('voucherForm').submit();
    }

    function updateCartQty(btn, change) {
        const form = btn.closest('form');
        const input = form.querySelector('input[name="quantity"]');
        let currentVal = parseInt(input.value);
        let newVal = currentVal + change;
        
        if (newVal === 0) {
            const removeUrl = btn.getAttribute('data-remove-url');
            openRemoveModal(removeUrl);
            return; 
        }

        if (newVal < 1) return; 

        input.value = newVal;
        form.submit();
    }
</script>
{% endblock %}