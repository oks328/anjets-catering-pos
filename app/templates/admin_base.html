<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Anjet's Admin{% endblock %}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin_style.css') }}"
    />
  </head>
  <body>
    <header>
      <h1>Anjet's Catering - Mission Control</h1>
    </header>

    {% if current_user.is_authenticated %}
    
    {% set active_page = request.endpoint %}
    <nav class="admin-nav">
      <ul>
        <li><a href="{{ url_for('admin_dashboard') }}" class="{{ 'active' if active_page == 'admin_dashboard' else '' }}">Dashboard</a></li>
        
        <li><a href="{{ url_for('admin_categories') }}" class="{{ 'active' if active_page == 'admin_categories' else '' }}">Categories</a></li>
        
        {% set product_pages = ['admin_products', 'admin_add_product', 'admin_edit_product', 'admin_product_variants', 'admin_import_products_csv'] %}
        <li><a href="{{ url_for('admin_products') }}" class="{{ 'active' if active_page in product_pages else '' }}">Products</a></li>
        
        <li><a href="{{ url_for('admin_orders') }}" class="{{ 'active' if active_page == 'admin_orders' else '' }}">Orders</a></li>
        
        <li><a href="{{ url_for('admin_vouchers') }}" class="{{ 'active' if active_page == 'admin_vouchers' else '' }}">Vouchers</a></li>

        {% set user_pages = ['admin_users', 'admin_add_user', 'admin_edit_user'] %}
        <li><a href="{{ url_for('admin_users') }}" class="{{ 'active' if active_page in user_pages else '' }}">Staff Management</a></li>
        
        {% set customer_pages = ['admin_customers', 'admin_edit_customer_page', 'admin_edit_customer'] %}
        <li><a href="{{ url_for('admin_customers') }}" class="{{ 'active' if active_page in customer_pages else '' }}">Customers</a></li>
        
        <li><a href="{{ url_for('admin_sales_reports') }}" class="{{ 'active' if active_page == 'admin_sales_reports' else '' }}">Sales Reports</a></li>
        
        <li><a href="{{ url_for('admin_logout') }}" style="color: #ffc107;">Logout ({{ current_user.username }})</a></li>
      </ul>
    </nav>
    {% endif %}

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flashedMessages" style="display: none;">
                    {% for category, message in messages %}
                        <span data-category="{{ category }}">{{ message | safe }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
    
        {% block content %}{% endblock %}
    </main>

    <footer>&copy; 2025 Anjet's Catering</footer>


    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h4>Confirm Deletion</h4>
        <p>
          Are you sure you want to delete this item? This action cannot be
          undone.
        </p>
        <div class="modal-actions">
          <button id="modalCancel" class="btn btn-secondary">Cancel</button>
          <button id="modalConfirmDelete" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
    <form id="modalDeleteForm" method="POST" style="display: none"></form>

    <div id="csvImportModal" class="modal">
    <div class="modal-content">
        <span class="modal-close-btn" id="csvModalCloseBtn">&times;</span>
        <h4>Import Products from CSV</h4>
        <p>Upload a CSV file with the required columns. <br>
            <strong>Required columns:</strong> `name`, `description`, `category_name`, `has_variants`, `price`, `size_name`
        </p>

        <form id="csvImportForm" method="POST" action="{{ url_for('admin_import_products_csv') }}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="csv_file">CSV File</label>
                <input type="file" id="csv_file" name="csv_file" class="form-control" accept=".csv" required>
            </div>
            <div class="modal-actions" style="margin-top: 1rem;">
                <button type="button" id="csvModalCancel" class="btn btn-secondary">Cancel</button>
                <button type="submit" id="csvImportSubmit" class="btn btn-primary">Upload and Import</button>
            </div>
        </form>
    </div>
</div>

    <div id="toastContainer"></div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
          // Get modal elements
          const modal = document.getElementById("deleteModal");
          const cancelBtn = document.getElementById("modalCancel");
          const closeBtn = document.querySelector(".modal-close-btn");
          const confirmDeleteBtn = document.getElementById("modalConfirmDelete");
          const modalDeleteForm = document.getElementById("modalDeleteForm");


          // Function to close the modal
          const closeModal = () => {
            modal.style.display = "none";
          };

          // Close modal when clicking "Cancel" or "X"
          cancelBtn.onclick = closeModal;
          closeBtn.onclick = closeModal;

          // Close modal when clicking outside of it
          window.onclick = (event) => {
            if (event.target == modal) {
              closeModal();
            }
          };

          // Find all delete forms
          document.querySelectorAll(".delete-form-modal").forEach((form) => {
            form.addEventListener("submit", function (e) {
              // Stop the form from submitting immediately
              e.preventDefault();

              // Get the URL from the form's 'action' attribute
              const formAction = this.action;

              // Set the hidden modal form's action
              modalDeleteForm.action = formAction;

              // Show the modal
              modal.style.display = "block";
            });
          });

          // When the user clicks the *real* delete button in the modal...
          confirmDeleteBtn.addEventListener("click", () => {
            // ...submit the hidden form
            modalDeleteForm.submit();
          });

          // --- Toast Notification Script ---
      const toastContainer = document.getElementById('toastContainer');

      function createToast(message, category) {
          // Create the toast element
          const toast = document.createElement('div');
          toast.classList.add('toast', `toast-${category}`); // e.g., toast-success

          // Create the message text
          const messageNode = document.createElement('span');
          messageNode.innerText = message;

          // Create a close button
          const closeBtn = document.createElement('button');
          closeBtn.classList.add('toast-close-btn');
          closeBtn.innerHTML = '&times;';

          // Function to close the toast
          const closeToast = () => {
              toast.style.animation = 'fadeOut 0.5s forwards';
              toast.addEventListener('animationend', () => {
                  toast.remove();
              });
          }

          closeBtn.onclick = closeToast;

          // Assemble the toast
          toast.appendChild(messageNode);
          toast.appendChild(closeBtn);

          // Add toast to the container
          if (toastContainer) {
            toastContainer.appendChild(toast);
          }

          // Set timeout to automatically remove the toast
          setTimeout(() => {
              // Check if the toast hasn't already been closed
              if (toast.parentElement) {
                  closeToast();
              }
          }, 5000); // 5 seconds
      }

       {% with messages = get_flashed_messages(with_categories=true) %}
           {% if messages %}
               {% for category, message in messages %}
                   // Call our function for each message
           createToast("{{ message | safe }}", "{{ category }}");
               {% endfor %}
           {% endif %}
       {% endwith %}
       // --- End of Toast Script ---

       // --- CSV Import Modal Script ---
    const importModal = document.getElementById('csvImportModal');
    const openImportModalBtn = document.getElementById('openCsvImportModal');
    const closeImportModalBtn = document.getElementById('csvModalCloseBtn');
    const cancelImportModalBtn = document.getElementById('csvModalCancel');
    const importForm = document.getElementById('csvImportForm');
    const importSubmitBtn = document.getElementById('csvImportSubmit');

    const openImportModal = () => {
        if (importModal) importModal.style.display = 'block';
    }
    const closeImportModal = () => {
        if (importModal) {
            importModal.style.display = 'none';
            if (importForm) importForm.reset(); // Clear the file input
            if (importSubmitBtn) {
                importSubmitBtn.disabled = false;
                importSubmitBtn.innerText = 'Upload and Import';
            }
        }
    }

    // Clicks to open/close
    if (openImportModalBtn) openImportModalBtn.onclick = openImportModal;
    if (closeImportModalBtn) closeImportModalBtn.onclick = closeImportModal;
    if (cancelImportModalBtn) cancelImportModalBtn.onclick = closeImportModal;

    // Show "Processing..." on submit
    if (importForm) {
        importForm.addEventListener('submit', () => {
            if (importSubmitBtn) {
                importSubmitBtn.disabled = true;
                importSubmitBtn.innerText = 'Processing...';
            }
        });
    }

        });
      </script>
      
      {% block scripts %}{% endblock %}
  </body>
</html>