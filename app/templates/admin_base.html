<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Anjet's Admin{% endblock %}</title>
    
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin_style.css') }}"
    />
    
    <link 
      rel="stylesheet" 
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    {% if request.endpoint == 'admin_login' %}
    <style>
        .body-no-sidebar {
            /* This overrides the default display: flex; in admin_style.css */
            display: block; 
        }
        .main-content-login {
            /* Centers the content on a full-width block display */
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            margin-left: 0 !important;
            width: 100vw !important;
            min-height: 100vh;
            padding: 0;
        }
        .login-container {
            margin: 0; /* Remove default card margins */
        }
    </style>
    {% endif %}
  </head>
  <body class="{% if request.endpoint == 'admin_login' %}body-no-sidebar{% endif %}">
    
    {% if request.endpoint != 'admin_login' %}
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Anjet's Admin</h3>
        </div>
        
        {% if current_user.is_authenticated %}
        {% set active_page = request.endpoint %}
        
        <nav class="sidebar-nav">
          <ul>
            <li>
                <a href="{{ url_for('admin_dashboard') }}" class="{{ 'active' if active_page == 'admin_dashboard' else '' }}">
                    <i class="fa-solid fa-table-columns"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            
            <li>
                <a href="{{ url_for('admin_categories') }}" class="{{ 'active' if active_page == 'admin_categories' else '' }}">
                    <i class="fa-solid fa-tags"></i>
                    <span>Categories</span>
                </a>
            </li>
            
            {% set product_pages = ['admin_products', 'admin_add_product', 'admin_edit_product', 'admin_product_variants', 'admin_import_products_csv'] %}
            <li>
                <a href="{{ url_for('admin_products') }}" class="{{ 'active' if active_page in product_pages else '' }}">
                    <i class="fa-solid fa-boxes-stacked"></i>
                    <span>Products</span>
                </a>
            </li>
            
            <li>
                <a href="{{ url_for('admin_orders') }}" class="{{ 'active' if active_page == 'admin_orders' else '' }}">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span>Orders</span>
                </a>
            </li>
            
            <li>
                <a href="{{ url_for('admin_vouchers') }}" class="{{ 'active' if active_page == 'admin_vouchers' else '' }}">
                    <i class="fa-solid fa-ticket-simple"></i>
                    <span>Vouchers</span>
                </a>
            </li>
            
            {% set user_rider_pages = ['admin_users', 'admin_add_user', 'admin_edit_user'] %}
            <li>
                <a href="{{ url_for('admin_users') }}" class="{{ 'active' if active_page in user_rider_pages else '' }}">
                    <i class="fa-solid fa-users"></i>
                    <span>Staff Users</span>
                </a>
            </li>

            {% set customer_pages = ['admin_customers', 'admin_edit_customer_page', 'admin_edit_customer'] %}
            <li>
                <a href="{{ url_for('admin_customers') }}" class="{{ 'active' if active_page in customer_pages else '' }}">
                    <i class="fa-solid fa-user-group"></i>
                    <span>Customers</span>
                </a>
            </li>
            
            {% set verification_pages = ['admin_verifications', 'admin_approve_discount', 'admin_deny_discount'] %}
            <li>
                <a href="{{ url_for('admin_verifications') }}" class="{{ 'active' if active_page in verification_pages else '' }}">
                    <i class="fa-solid fa-user-check"></i>
                    <span>Verifications</span>
                </a>
            </li>

            <li>
                <a href="{{ url_for('admin_sales_reports') }}" class="{{ 'active' if active_page == 'admin_sales_reports' else '' }}">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Sales Reports</span>
                </a>
            </li>
          </ul>
        </nav>
        {% endif %}

        <div class="sidebar-user">
            <div class="sidebar-user-avatar">
                {{ current_user.username[0]|upper if current_user.is_authenticated else 'A' }}
            </div>
            <div class="sidebar-user-info">
                {% if current_user.is_authenticated %}
                    <strong>{{ current_user.username }}</strong>
                    <a href="{{ url_for('admin_logout') }}">Logout</a>
                {% else %}
                    <strong>Not Logged In</strong>
                    <a href="{{ url_for('admin_login') }}">Log In</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    <div class="{% if request.endpoint == 'admin_login' %}main-content-login{% else %}main-content{% endif %}">
        <main>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div id="flashedMessages" style="display: none;">
                        {% for category, message in messages %}
                            <span data-category="{{ category }}">{{ message | safe }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
        
            {% block content %}{% endblock %}
        </main>
    </div>

    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h4 style="color: var(--danger-red);">
            <i class="fa-solid fa-triangle-exclamation"></i> Security Check
        </h4>
        <p>
          This action is <strong>permanent</strong> and cannot be undone.
        </p>
        <p id="modalWarningText" style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
            Please enter your admin password to confirm.
        </p>
        
        <form id="modalDeleteForm" method="POST" action="">
            <div class="form-group">
                <div class="password-container">
                    <input type="password" name="admin_confirm_password" class="form-control" 
                           placeholder="Enter Admin Password" required autocomplete="off" 
                           id="modal_password_field">
                    <i class="fas fa-eye toggle-password" id="modal_toggle_password"></i>
                </div>
                </div>
            
            <div class="modal-actions">
                <button type="button" id="modalCancel" class="btn btn-secondary">Cancel</button>
                <button type="submit" id="modalConfirmDelete" class="btn btn-danger">Confirm Delete</button>
            </div>
        </form>
      </div>
    </div>

    <div id="toastContainer"></div>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          
          // --- 1. DELETE MODAL LOGIC ---
          const modal = document.getElementById("deleteModal");
          const modalForm = document.getElementById("modalDeleteForm");
          const cancelBtn = document.getElementById("modalCancel");
          const closeBtn = document.querySelector(".modal-close-btn");

          // Function to close the modal and clear password
          const closeModal = () => {
            if (modal) {
                modal.style.display = "none";
                // Clear password field for security
                const passField = modalForm.querySelector('input[name="admin_confirm_password"]');
                if(passField) passField.value = '';
            }
          };

          // Close modal when clicking "Cancel" or "X"
          if (cancelBtn) cancelBtn.onclick = closeModal;
          if (closeBtn) closeBtn.onclick = closeModal;

          // Close modal when clicking outside of it
          window.onclick = (event) => {
            if (event.target == modal) {
              closeModal();
            }
            // Handle CSV Modal closing as well if it exists
            const csvModal = document.getElementById('csvImportModal');
            if (event.target == csvModal) {
                csvModal.style.display = 'none';
            }
          };

          // Attach listeners to all delete buttons
          document.querySelectorAll(".delete-form-modal").forEach((form) => {
            form.addEventListener("submit", function (e) {
              e.preventDefault(); // Stop immediate submit

              // 1. Get the action URL from the specific delete button's form
              const targetUrl = this.action;
              
              // 2. Update the Modal's form action to match
              modalForm.action = targetUrl;

              // 3. Show the modal
              modal.style.display = "block";
              
              // 4. Focus on password field for usability
              const passField = modalForm.querySelector('input[name="admin_confirm_password"]');
              if(passField) passField.focus();
            });
          });
          
          // --- NEW: MODAL PASSWORD TOGGLE LOGIC ---
          const modalTogglePassword = document.getElementById('modal_toggle_password');
          const modalPasswordField = document.getElementById('modal_password_field');
          
          if (modalTogglePassword && modalPasswordField) {
              modalTogglePassword.addEventListener('click', function() {
                  // Toggle the type attribute
                  const type = modalPasswordField.getAttribute('type') === 'password' ? 'text' : 'password';
                  modalPasswordField.setAttribute('type', type);

                  // Toggle the icon (fa-eye vs fa-eye-slash)
                  this.classList.toggle('fa-eye');
                  this.classList.toggle('fa-eye-slash');
              });
          }
          // --- END NEW LOGIC ---

          // --- 2. TOAST NOTIFICATION LOGIC ---
          const toastContainer = document.getElementById('toastContainer');

          function createToast(message, category) {
              const toast = document.createElement('div');
              toast.classList.add('toast', `toast-${category}`);

              const messageNode = document.createElement('span');
              messageNode.innerText = message;

              const closeBtn = document.createElement('button');
              closeBtn.classList.add('toast-close-btn');
              closeBtn.innerHTML = '&times;';

              const closeToast = () => {
                  toast.style.animation = 'fadeOut 0.5s forwards';
                  toast.addEventListener('animationend', () => {
                      toast.remove();
                  });
              }

              closeBtn.onclick = closeToast;
              toast.appendChild(messageNode);
              toast.appendChild(closeBtn);

              if (toastContainer) {
                toastContainer.appendChild(toast);
              }

              setTimeout(() => {
                  if (toast.parentElement) {
                      closeToast();
                  }
              }, 5000);
          }

          // Process any flashed messages embedded by Jinja
          const flashedMessages = document.getElementById('flashedMessages');
          if (flashedMessages) {
              const spans = flashedMessages.querySelectorAll('span');
              spans.forEach(span => {
                  createToast(span.innerText, span.dataset.category);
              });
          }


          // --- 3. CSV IMPORT MODAL LOGIC (Placeholder) ---
          const importModal = document.getElementById('csvImportModal');
          const openImportModalBtn = document.getElementById('openCsvImportModal');
          const closeImportModalBtn = document.getElementById('csvModalCloseBtn');
          const cancelImportModalBtn = document.getElementById('csvModalCancel');
          const importForm = document.getElementById('csvImportForm');
          const importSubmitBtn = document.getElementById('csvImportSubmit');

          const openImportModal = () => {
              if (importModal) importModal.style.display = 'block';
          }
          const closeImportModal = () => {
              if (importModal) {
                  importModal.style.display = 'none';
                  if (importForm) importForm.reset();
                  if (importSubmitBtn) {
                      importSubmitBtn.disabled = false;
                      importSubmitBtn.innerText = 'Upload and Import';
                  }
              }
          }

          if (openImportModalBtn) openImportModalBtn.onclick = openImportModal;
          if (closeImportModalBtn) closeImportModalBtn.onclick = closeImportModal;
          if (cancelImportModalBtn) cancelImportModalBtn.onclick = closeImportModal;

          if (importForm) {
              importForm.addEventListener('submit', () => {
                  if (importSubmitBtn) {
                      importSubmitBtn.disabled = true;
                      importSubmitBtn.innerText = 'Processing...';
                  }
              });
          }

        });
      </script>
      
      {% block scripts %}{% endblock %}
  </body>
</html>