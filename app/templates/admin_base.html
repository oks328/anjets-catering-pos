<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Anjet's Admin{% endblock %}</title>
    
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin_style.css') }}"
    />
    
    <link 
      rel="stylesheet" 
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>
  <body>
    
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Anjet's Catering</h3>
        </div>
        
        {% if current_user.is_authenticated %}
        {% set active_page = request.endpoint %}
        
        <nav class="sidebar-nav">
          <ul>
            <li>
                <a href="{{ url_for('admin_dashboard') }}" class="{{ 'active' if active_page == 'admin_dashboard' else '' }}">
                    <i class="fa-solid fa-table-columns"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            
            <li>
                <a href="{{ url_for('admin_categories') }}" class="{{ 'active' if active_page == 'admin_categories' else '' }}">
                    <i class="fa-solid fa-tags"></i>
                    <span>Categories</span>
                </a>
            </li>
            
            {% set product_pages = ['admin_products', 'admin_add_product', 'admin_edit_product', 'admin_product_variants', 'admin_import_products_csv'] %}
            <li>
                <a href="{{ url_for('admin_products') }}" class="{{ 'active' if active_page in product_pages else '' }}">
                    <i class="fa-solid fa-boxes-stacked"></i>
                    <span>Products</span>
                </a>
            </li>
            
            <li>
                <a href="{{ url_for('admin_orders') }}" class="{{ 'active' if active_page == 'admin_orders' else '' }}">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span>Orders</span>
                </a>
            </li>
            
            <li>
                <a href="{{ url_for('admin_vouchers') }}" class="{{ 'active' if active_page == 'admin_vouchers' else '' }}">
                    <i class="fa-solid fa-ticket-simple"></i>
                    <span>Vouchers</span>
                </a>
            </li>
            
            {% set user_rider_pages = ['admin_users', 'admin_add_user', 'admin_edit_user'] %}
            <li>
                <a href="{{ url_for('admin_users') }}" class="{{ 'active' if active_page in user_rider_pages else '' }}">
                    <i class="fa-solid fa-users"></i>
                    <span>Staff Users</span>
                </a>
            </li>

            {% set customer_pages = ['admin_customers', 'admin_edit_customer_page', 'admin_edit_customer'] %}
            <li>
                <a href="{{ url_for('admin_customers') }}" class="{{ 'active' if active_page in customer_pages else '' }}">
                    <i class="fa-solid fa-user-group"></i>
                    <span>Customers</span>
                </a>
            </li>
            
            {% set verification_pages = ['admin_verifications', 'admin_approve_discount', 'admin_deny_discount'] %}
            <li>
                <a href="{{ url_for('admin_verifications') }}" class="{{ 'active' if active_page in verification_pages else '' }}">
                    <i class="fa-solid fa-user-check"></i>
                    <span>Verifications</span>
                </a>
            </li>

            <li>
                <a href="{{ url_for('admin_sales_reports') }}" class="{{ 'active' if active_page == 'admin_sales_reports' else '' }}">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Sales Reports</span>
                </a>
            </li>
          </ul>
        </nav>
        {% endif %}

        <div class="sidebar-user">
            <div class="sidebar-user-avatar">
                {{ current_user.username[0]|upper if current_user.is_authenticated else 'A' }}
            </div>
            <div class="sidebar-user-info">
                {% if current_user.is_authenticated %}
                    <strong>{{ current_user.username }}</strong>
                    <a href="{{ url_for('admin_logout') }}">Logout</a>
                {% else %}
                    <strong>Not Logged In</strong>
                    <a href="{{ url_for('admin_login') }}">Log In</a>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="main-content">
        <main>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div id="flashedMessages" style="display: none;">
                        {% for category, message in messages %}
                            <span data-category="{{ category }}">{{ message | safe }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
        
            {% block content %}{% endblock %}
        </main>
    </div>
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="modal-close-btn">&times;</span>
        <h4>Confirm Deletion</h4>
        <p>
          Are you sure you want to delete this item? This action cannot be
          undone.
        </p>
        <div class="modal-actions">
          <button id="modalCancel" class="btn btn-secondary">Cancel</button>
          <button id="modalConfirmDelete" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
    <form id="modalDeleteForm" method="POST" style="display: none"></form>

    <div id="toastContainer"></div>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          // Get modal elements
          const modal = document.getElementById("deleteModal");
          const cancelBtn = document.getElementById("modalCancel");
          const closeBtn = document.querySelector(".modal-close-btn");
          const confirmDeleteBtn = document.getElementById("modalConfirmDelete");
          const modalDeleteForm = document.getElementById("modalDeleteForm");


          // Function to close the modal
          const closeModal = () => {
            if (modal) modal.style.display = "none";
          };

          // Close modal when clicking "Cancel" or "X"
          if (cancelBtn) cancelBtn.onclick = closeModal;
          if (closeBtn) closeBtn.onclick = closeModal;

          // Close modal when clicking outside of it
          window.onclick = (event) => {
            if (event.target == modal) {
              closeModal();
            }
          };

          // Find all delete forms
          document.querySelectorAll(".delete-form-modal").forEach((form) => {
            form.addEventListener("submit", function (e) {
              // Stop the form from submitting immediately
              e.preventDefault();

              // Get the URL from the form's 'action' attribute
              const formAction = this.action;

              // Set the hidden modal form's action
              modalDeleteForm.action = formAction;

              // Show the modal
              modal.style.display = "block";
            });
          });

          // When the user clicks the *real* delete button in the modal...
          if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener("click", () => {
              // ...submit the hidden form
              modalDeleteForm.submit();
            });
          }

          // --- Toast Notification Script ---
      const toastContainer = document.getElementById('toastContainer');

      function createToast(message, category) {
          // Create the toast element
          const toast = document.createElement('div');
          toast.classList.add('toast', `toast-${category}`); // e.g., toast-success

          // Create the message text
          const messageNode = document.createElement('span');
          messageNode.innerText = message;

          // Create a close button
          const closeBtn = document.createElement('button');
          closeBtn.classList.add('toast-close-btn');
          closeBtn.innerHTML = '&times;';

          // Function to close the toast
          const closeToast = () => {
              toast.style.animation = 'fadeOut 0.5s forwards';
              toast.addEventListener('animationend', () => {
                  toast.remove();
              });
          }

          closeBtn.onclick = closeToast;

          // Assemble the toast
          toast.appendChild(messageNode);
          toast.appendChild(closeBtn);

          // Add toast to the container
          if (toastContainer) {
            toastContainer.appendChild(toast);
          }

          // Set timeout to automatically remove the toast
          setTimeout(() => {
              // Check if the toast hasn't already been closed
              if (toast.parentElement) {
                  closeToast();
              }
          }, 5000); // 5 seconds
      }

       {% with messages = get_flashed_messages(with_categories=true) %}
           {% if messages %}
               {% for category, message in messages %}
                   // Call our function for each message
           createToast("{{ message | safe }}", "{{ category }}");
               {% endfor %}
           {% endif %}
       {% endwith %}
       // --- End of Toast Script ---

       // --- CSV Import Modal Script ---
    const importModal = document.getElementById('csvImportModal');
    const openImportModalBtn = document.getElementById('openCsvImportModal');
    const closeImportModalBtn = document.getElementById('csvModalCloseBtn');
    const cancelImportModalBtn = document.getElementById('csvModalCancel');
    const importForm = document.getElementById('csvImportForm');
    const importSubmitBtn = document.getElementById('csvImportSubmit');

    const openImportModal = () => {
        if (importModal) importModal.style.display = 'block';
    }
    const closeImportModal = () => {
        if (importModal) {
            importModal.style.display = 'none';
            if (importForm) importForm.reset(); // Clear the file input
            if (importSubmitBtn) {
                importSubmitBtn.disabled = false;
                importSubmitBtn.innerText = 'Upload and Import';
            }
        }
    }

    // Clicks to open/close
    if (openImportModalBtn) openImportModalBtn.onclick = openImportModal;
    if (closeImportModalBtn) closeImportModalBtn.onclick = closeImportModal;
    if (cancelImportModalBtn) cancelImportModalBtn.onclick = closeImportModal;

    // Show "Processing..." on submit
    if (importForm) {
        importForm.addEventListener('submit', () => {
            if (importSubmitBtn) {
                importSubmitBtn.disabled = true;
                importSubmitBtn.innerText = 'Processing...';
            }
        });
    }

        });
      </script>
      
      {% block scripts %}{% endblock %}
  </body>
</html>