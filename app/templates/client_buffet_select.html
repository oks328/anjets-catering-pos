{% extends "base.html" %}

{% block title %}Choose {{ category_name }} Dishes{% endblock %}

{% block content %}
<div class="wizard-container">
    
    <div class="wizard-progress-container">
        <div class="wizard-step-text">
            <span>Step {{ current_step }} of {{ total_steps }}</span>
            <span>{{ category_name }}</span>
        </div>
        <div class="wizard-progress-bar">
            {% for i in range(total_steps) %}
                <div class="wizard-progress-step {{ 'active' if i < current_step else '' }}"></div>
            {% endfor %}
        </div>
    </div>

    <div class="buffet-recommendation" style="margin-bottom: 3rem;">
        <h3>Choose {{ category_name }} Dishes</h3>
        <p>
            {% if is_main_category %}
                You need <strong>{{ required_count }}</strong> Main Dishes total (Pork, Beef, Chicken, Seafood).
                <br>
                <span style="color: {{ '#28a745' if current_count >= required_count else '#d9534f' }}; font-weight: bold;">
                    (Total Selected Mains: {{ current_count }} / {{ required_count }})
                </span>
            {% else %}
                You must select {{ required_count }} items from this category.
                <br>
                <span style="color: {{ '#28a745' if current_count >= required_count else '#d9534f' }}; font-weight: bold;">
                    (Selected: {{ current_count }} / Required: {{ required_count }})
                </span>
            {% endif %}
        </p>

        <div class="wizard-nav-buttons" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem;">
            <a href="{{ previous_url }}" class="btn btn-secondary">
                &larr; Go Back
            </a>

            <a href="{{ next_url }}" 
               id="btn-continue" 
               class="btn btn-primary"
               {% if current_count < min_to_proceed %}disabled{% endif %}>
                {% if is_final_category %}
                    Review Your Buffet &rarr;
                {% else %}
                    Continue to Next Category &rarr;
                {% endif %}
            </a>
        </div>
    </div>

    {% if current_selections %}
    <div class="card" style="margin-bottom: 2rem;">
        <h4>Your Current {{ category_name }} Selections:</h4>
        <table class="order-history-table">
            <tbody>
                {% for item in current_selections %}
                <tr>
                    <td>{{ item.quantity }}x</td>
                    <td style="width: 80%;"><strong>{{ item.product_name }}</strong> ({{ item.variant_name }})</td>
                    <td class="action-buttons">
                        <a href="{{ url_for('buffet_remove_item_from_package', variant_id=item.variant_id, category_name=category_name) }}" 
                           style="color: #d9534f; font-weight: bold;">
                            Remove
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="product-grid">
        {% for product in products %}
        <div class="product-card">
            <img src="{{ url_for('static', filename='uploads/products/' + product.image_file) }}" 
                 alt="{{ product.name }}" 
                 class="product-card-image">

            <div class="product-card-content">
                <h3>{{ product.name }}</h3>
                <p>{{ product.description or 'No description available.' }}</p>

                <div class="product-card-footer">
                    <div class="product-card-price">
                        {% if product.has_variants %}
                            {% if product.variants %}
                                <span class="price-small">Starts at</span>
                                ₱{{ "%.2f"|format(product.variants|map(attribute='price')|min) }}
                            {% else %}
                                <span style="color:red; font-size: 0.9rem;">Price not set</span>
                            {% endif %}
                        {% else %}
                            {% if product.variants %}
                                ₱{{ "%.2f"|format(product.variants[0].price) }}
                            {% else %}
                                <span style="color:red; font-size: 0.9rem;">Price not set</span>
                            {% endif %}
                        {% endif %}
                    </div>

                    <button class="btn btn-secondary btn-open-product-modal" data-product-id="{{ product.product_id }}">
                        Add
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <p>No products found in this category.</p>
        {% endfor %}
    </div>
    
    <div class="buffet-floating-total">
        <span>Estimated Total:</span>
        <span class="total-amount" id="running-total">₱{{ "%.2f"|format(current_total_price) }}</span>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // Set flag for base.html to know this is the buffet page
    window.isBuffetPage = true; 

    document.addEventListener('DOMContentLoaded', () => {
        const modalCartForm = document.getElementById('modalCartForm');
        const warningModal = document.getElementById('warningModal');
        const warningModalCloseBtn = document.getElementById('warningModalCloseBtn');
        const warningModalCancelBtn = document.getElementById('warningModalCancel');
        const warningModalConfirmBtn = document.getElementById('warningModalConfirm');
        const warningModalMessage = document.getElementById('warningModalMessage');
        const runningTotalEl = document.getElementById('running-total');

        // Disable continue logic
        const continueBtn = document.getElementById('btn-continue');
        if (continueBtn) {
            continueBtn.addEventListener('click', function(e) {
                if (this.hasAttribute('disabled')) {
                    e.preventDefault();
                    warningModalMessage.innerText = 'You must select the required number of items to continue.';
                    warningModal.style.display = 'block';
                    warningModalConfirmBtn.style.display = 'none';
                }
            });
        }
        
        const closeWarningModal = () => {
            if (warningModal) warningModal.style.display = 'none';
            warningModalConfirmBtn.style.display = 'inline-block';
        }
        if (warningModalCloseBtn) warningModalCloseBtn.onclick = closeWarningModal;
        if (warningModalCancelBtn) warningModalCancelBtn.onclick = closeWarningModal;

        // Handle Submit
        if (modalCartForm) {
            modalCartForm.onsubmit = function(e) {
                e.preventDefault(); 
                const formData = new FormData(modalCartForm);
                handleFetch(formData);
            };
        }

        function handleFetch(dataToPost) {
            fetch("{{ url_for('buffet_add_item') }}", {
                method: 'POST',
                body: dataToPost
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload the page to show new counts
                    location.reload(); 
                    // NOTE: We rely on page reload to update table/counts, 
                    // so the total update below happens on reload anyway.
                    
                } else if (data.status === 'warning') {
                    warningModalMessage.innerText = data.message;
                    warningModal.style.display = 'block';
                    warningModalConfirmBtn.style.display = 'inline-block';

                    warningModalConfirmBtn.onclick = () => {
                        dataToPost.append('force', 'true');
                        handleFetch(dataToPost);
                        closeWarningModal();
                    }
                } else {
                    createToast(data.message, 'danger');
                }
            })
            .catch(err => {
                console.error('Error adding to buffet cart:', err);
                createToast('An error occurred. Please try again.', 'danger');
            });
        }
    });
</script>
{% endblock %}