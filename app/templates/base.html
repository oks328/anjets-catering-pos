<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Anjet's Catering{% endblock %}</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/client_style.css') }}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    {% block styles %}{% endblock %}
</head>
<body>
    <header class="client-header">
        <div class="logo">
            <a href="{{ url_for('client_home') }}">Anjet's</a>
        </div>
        
        <nav class="client-nav-center">
            <a href="{{ url_for('client_home') }}" class="{{ 'active' if request.endpoint == 'client_home' else '' }}">Home</a>
            <a href="{{ url_for('client_menu') }}" class="{{ 'active' if request.endpoint == 'client_menu' else '' }}">Menu</a>
            <a href="{{ url_for('buffet_wizard_start') }}" class="{{ 'active' if request.endpoint == 'buffet_wizard_start' else '' }}">Build a Buffet</a>
        </nav>

        <div class="client-nav-right">
            {% if 'customer_id' in session %}
                <a href="{{ url_for('client_cart') }}" class="icon-link" title="My Cart">
                    <i class="fa-solid fa-cart-shopping"></i>
                </a>
                <a href="{{ url_for('client_my_account') }}" class="icon-link" title="My Profile">
                    <i class="fa-regular fa-user"></i>
                </a>
                <a href="{{ url_for('client_logout') }}" class="icon-link" title="Logout" style="margin-left: 10px;">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </a>
            {% else %}
                <a href="{{ url_for('client_account_page') }}" class="btn btn-login">Login</a>
            {% endif %}
        </div>
    </header>

    <main class="client-main">
        {% block content %}{% endblock %}
    </main>

    <footer class="client-footer">
        <p>&copy; 2025 Anjet's. All rights reserved.</p>
    </footer>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <div class="modal-header">
                <h2 id="modalProductName">Product Name</h2>
            </div>
            <form id="modalCartForm" method="POST" action="{{ url_for('add_to_cart') }}">
                <div class="modal-body">
                    <input type="hidden" id="modalProductId" name="product_id">
                    <div id="modalVariantSelector" class="form-group" style="margin-bottom: 1rem;">
                        <label for="modalVariantId" id="modalVariantLabel" style="font-weight:bold;">Size</label>
                        <select id="modalVariantId" name="variant_id" class="form-control"></select>
                    </div>
                    <div id="modalCurrentCount" class="modal-current-count" style="display: none; margin-bottom: 1rem;"></div>
                    <div class="form-group">
                        <label for="modalQuantity" style="font-weight:bold;">Quantity to Add</label>
                        <div class="quantity-stepper">
                            <button type="button" class="btn-qty" id="modal-btn-minus">-</button>
                            <input type="number" id="modalQuantity" name="quantity" class="form-control-qty" value="1" min="1">
                            <button type="button" class="btn-qty" id="modal-btn-plus">+</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-card-add" style="width: 100%;">Add to Cart</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="clearCartModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="clearCartModalCloseBtn">&times;</span>
            <h4>Confirm Action</h4>
            <p>Are you sure you want to clear your entire shopping cart? This action cannot be undone.</p>
            <div class="modal-actions" style="text-align: right; margin-top: 1rem;">
                <button type="button" id="clearCartModalCancel" class="btn btn-secondary">Cancel</button>
                <a href="#" id="clearCartModalConfirm" class="btn btn-danger">Yes, Clear Cart</a>
            </div>
        </div>
    </div>
    
    <div id="warningModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="warningModalCloseBtn">&times;</span>
            <h4>Are you sure?</h4>
            <p id="warningModalMessage">This is a warning message.</p>
            <div class="modal-actions" style="text-align: right; margin-top: 1rem;">
                <button type="button" id="warningModalCancel" class="btn btn-secondary">Cancel</button>
                <button type="button" id="warningModalConfirm" class="btn btn-primary">Add Anyway</button>
            </div>
        </div>
    </div>
    
    <div id="toastContainer"></div>

    <script>
        // --- Global Toast Function ---
        function createToast(message, category) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return; 
            
            const toast = document.createElement('div');
            toast.classList.add('toast', `toast-${category}`);
            
            const messageNode = document.createElement('span');
            messageNode.innerText = message;
            
            const closeBtn = document.createElement('button');
            closeBtn.classList.add('toast-close-btn');
            closeBtn.innerHTML = '&times;';
            
            const closeToast = () => {
                toast.style.animation = 'fadeOut 0.5s forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }
            
            closeBtn.onclick = closeToast;
            toast.appendChild(messageNode);
            toast.appendChild(closeBtn);
            toastContainer.appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) closeToast();
            }, 5000); 
        }
        
        // --- GLOBAL HELPER: Opens the Custom Clear Cart Modal ---
        window.openClearCartModal = function(url) {
            const clearCartModal = document.getElementById('clearCartModal');
            const clearCartModalConfirmBtn = document.getElementById('clearCartModalConfirm');
            
            if (clearCartModal && clearCartModalConfirmBtn) {
                clearCartModalConfirmBtn.href = url; 
                clearCartModal.style.display = 'block';
            }
        }

        // --- Global Page Load & Modal Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Show flashed messages from server
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        createToast("{{ message | safe }}", "{{ category }}");
                    {% endfor %}
                {% endif %}
            {% endwith %}

            // 2. --- Clear Cart Modal Setup ---
            const clearCartModal = document.getElementById('clearCartModal');
            const clearCartModalCloseBtn = document.getElementById('clearCartModalCloseBtn');
            const clearCartModalCancelBtn = document.getElementById('clearCartModalCancel');
            
            const closeClearCartModal = () => {
                if (clearCartModal) clearCartModal.style.display = 'none';
            }

            if (clearCartModalCloseBtn) clearCartModalCloseBtn.onclick = closeClearCartModal;
            if (clearCartModalCancelBtn) clearCartModalCancelBtn.onclick = closeClearCartModal;

            
            // 3. --- Product Modal Setup and Initialization ---
            const modal = document.getElementById('productModal');
            if (!modal) return; 

            const closeModalBtn = modal.querySelector('.modal-close-btn');
            const modalProductName = document.getElementById('modalProductName');
            const modalProductId = document.getElementById('modalProductId');
            const modalVariantSelector = document.getElementById('modalVariantSelector');
            const modalVariantLabel = document.getElementById('modalVariantLabel');
            const modalVariantSelect = document.getElementById('modalVariantId');
            const modalCartForm = document.getElementById('modalCartForm');
            const modalQuantityInput = document.getElementById('modalQuantity');
            const modalBtnMinus = document.getElementById('modal-btn-minus');
            const modalBtnPlus = document.getElementById('modal-btn-plus');
            const modalCurrentCount = document.getElementById('modalCurrentCount');
            
            let allVariantsData = [];

            // 4. --- Global Modal Close Logic ---
            const closeProductModal = () => {
                modal.style.display = 'none';
            }
            closeModalBtn.onclick = closeProductModal;
            
            // Ensure clicking outside closes EITHER the Product or Clear Cart modal
            window.onclick = (event) => {
                if (event.target == modal) closeProductModal();
                if (event.target == clearCartModal) closeClearCartModal();
                const warningModal = document.getElementById('warningModal');
                if (warningModal && event.target == warningModal) warningModal.style.display = 'none';
            };

            // 5. --- Global Quantity Stepper Logic ---
            if (modalBtnMinus && modalBtnPlus) {
                modalBtnMinus.addEventListener('click', () => {
                    let currentVal = parseInt(modalQuantityInput.value);
                    if (currentVal > 1) {
                        modalQuantityInput.value = currentVal - 1;
                    }
                });
                modalBtnPlus.addEventListener('click', () => {
                    let currentVal = parseInt(modalQuantityInput.value);
                    modalQuantityInput.value = currentVal + 1;
                });
            }
            
            // 6. --- Global Buffet Counter Logic ---
            function updateBuffetCounter() {
                const selectedVariantId = modalVariantSelect.value;
                const variantData = allVariantsData.find(v => v.id == selectedVariantId);
                if (modalCurrentCount) {
                    if (variantData && variantData.current_quantity > 0) {
                        modalCurrentCount.innerText = `You have ${variantData.current_quantity} of this item in your buffet.`;
                        modalCurrentCount.style.display = 'block';
                    } else {
                        modalCurrentCount.style.display = 'none';
                    }
                }
            }
            modalVariantSelect.addEventListener('change', updateBuffetCounter);

            // 7. --- Global Modal Open Logic ---
            document.querySelectorAll('.btn-open-product-modal').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const productId = this.dataset.productId;
                    
                    fetch(`/product_details/${productId}`)
                        .then(response => response.json())
                        .then(data => {
                            modalProductName.innerText = data.name;
                            modalProductId.value = data.id;
                            modalQuantityInput.value = 1; 
                            
                            allVariantsData = data.variants; 
                            modalVariantSelect.innerHTML = ''; 
                            
                            if (data.has_variants) {
                                modalVariantSelector.style.display = 'block';
                                modalVariantLabel.style.display = 'block';
                                data.variants.forEach(variant => {
                                    const option = document.createElement('option');
                                    option.value = variant.id;
                                    option.innerText = `${variant.size} - ₱${variant.price.toFixed(2)}`;
                                    modalVariantSelect.appendChild(option);
                                });
                            } else {
                                modalVariantSelector.style.display = 'block';
                                modalVariantLabel.style.display = 'none';
                                if (data.variants.length > 0) {
                                    const variant = data.variants[0];
                                    const option = document.createElement('option');
                                    option.value = variant.id;
                                    option.innerText = `${variant.size} - ₱${variant.price.toFixed(2)}`;
                                    modalVariantSelect.appendChild(option);
                                }
                            }
                            
                            // Check if this button is on the buffet page
                            if (button.hasAttribute('data-category')) {
                                window.isBuffetPage = true;
                                modalCartForm.action = "{{ url_for('buffet_add_item') }}";
                                updateBuffetCounter(); 
                            } else {
                                window.isBuffetPage = false;
                                modalCartForm.action = "{{ url_for('add_to_cart') }}";
                                if (modalCurrentCount) modalCurrentCount.style.display = 'none'; 
                            }
                            
                            modal.style.display = 'block';
                        });
                });
            }); 

            // 8. --- Global Form Submit Logic (Only for Product Modal) ---
            if (modalCartForm) {
                if (window.isBuffetPage === true) {
                    // Do nothing. The local script from 'client_buffet_select.html' handles this.
                } else {
                    modalCartForm.onsubmit = function(e) {
                        e.preventDefault(); 
                        const formData = new FormData(modalCartForm);

                        fetch("{{ url_for('add_to_cart') }}", {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                createToast(data.message, 'success');
                                closeProductModal(); 
                            
                            } else if (data.status === 'login_required') {
                                createToast('You must log in to add items to your cart.', 'danger');
                                window.location.href = data.url; 
                            
                            } else {
                                createToast(data.message, 'danger');
                            }
                        })
                        .catch(err => {
                            console.error('Error adding to cart:', err);
                            createToast('An error occurred. Please try again.', 'danger');
                        });
                    }
                }
            } 

        }); 
    </script>

    {% block scripts %}{% endblock %}
    
</body>
</html>